name: Run Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Playwright
      run: |
        npm install -D @playwright/test
        npx playwright install --with-deps ${{ matrix.browser }}

    - name: Create Playwright config
      run: |
        cat > playwright.config.js << 'EOF'
        import { defineConfig, devices } from '@playwright/test';

        export default defineConfig({
          testDir: './e2e',
          timeout: 60000,
          fullyParallel: false,
          forbidOnly: !!process.env.CI,
          retries: process.env.CI ? 2 : 0,
          workers: 1,
          reporter: [['html'], ['list']],
          use: {
            baseURL: 'http://localhost:8000',
            trace: 'on-first-retry',
            screenshot: 'only-on-failure',
            video: 'retain-on-failure',
          },
          projects: [
            {
              name: 'chromium',
              use: { ...devices['Desktop Chrome'] },
            },
            {
              name: 'firefox',
              use: { ...devices['Desktop Firefox'] },
            },
            {
              name: 'webkit',
              use: { ...devices['Desktop Safari'] },
            },
          ],
          webServer: {
            command: 'python3 -m http.server 8000',
            port: 8000,
            timeout: 120 * 1000,
            reuseExistingServer: !process.env.CI,
          },
        });
        EOF

    - name: Create E2E test directory
      run: mkdir -p e2e

    - name: Create E2E tests
      run: |
        cat > e2e/game.spec.js << 'EOF'
        import { test, expect } from '@playwright/test';

        test.describe('Crystal Blitz - Basic Smoke Tests', () => {
          test('game page loads successfully', async ({ page }) => {
            await page.goto('/');

            // Check title
            await expect(page).toHaveTitle(/CRYSTAL BLITZ/);

            // Check for canvas element
            const canvas = page.locator('canvas');
            await expect(canvas).toBeVisible();
          });

          test('no console errors on load', async ({ page }) => {
            const consoleErrors = [];
            page.on('console', msg => {
              if (msg.type() === 'error') {
                consoleErrors.push(msg.text());
              }
            });

            await page.goto('/');
            await page.waitForLoadState('networkidle');

            // Should have no console errors
            expect(consoleErrors).toHaveLength(0);
          });
        });
        EOF

    - name: Run Playwright tests
      run: npx playwright test --project=${{ matrix.browser }}

    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report-${{ matrix.browser }}
        path: playwright-report/
        retention-days: 30

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for console.log statements
      run: |
        if grep -n "console\.log" index.html | grep -v "// console.log" | grep -v "console.warn"; then
          echo "❌ Found console.log statements in production code:"
          grep -n "console\.log" index.html | grep -v "// console.log" | grep -v "console.warn"
          exit 1
        else
          echo "✅ No console.log statements found"
        fi

    - name: Check file size
      run: |
        SIZE=$(wc -c < index.html)
        if [ $SIZE -gt 500000 ]; then
          echo "⚠️  Warning: index.html is larger than 500KB ($SIZE bytes)"
        else
          echo "✅ File size OK: $SIZE bytes"
        fi

    - name: Validate HTML structure
      run: |
        # Check for basic HTML structure (case-insensitive)
        if ! grep -qi "<!doctype html>" index.html; then
          echo "❌ Missing DOCTYPE declaration"
          exit 1
        fi
        if ! grep -q "<canvas" index.html; then
          echo "❌ Missing canvas element"
          exit 1
        fi
        echo "✅ HTML structure valid"

  performance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Playwright
      run: |
        npm install -D @playwright/test
        npx playwright install --with-deps chromium

    - name: Create Playwright config
      run: |
        cat > playwright.config.js << 'EOF'
        import { defineConfig, devices } from '@playwright/test';

        export default defineConfig({
          testDir: './e2e',
          timeout: 60000,
          fullyParallel: false,
          forbidOnly: !!process.env.CI,
          retries: process.env.CI ? 2 : 0,
          workers: 1,
          reporter: [['html'], ['list']],
          use: {
            baseURL: 'http://localhost:8000',
            trace: 'on-first-retry',
            screenshot: 'only-on-failure',
            video: 'retain-on-failure',
          },
          projects: [
            {
              name: 'chromium',
              use: { ...devices['Desktop Chrome'] },
            },
          ],
        });
        EOF

    - name: Create e2e directory
      run: mkdir -p e2e

    - name: Create performance test runner
      run: |
        cat > e2e/performance.spec.js << 'EOF'
        import { test, expect } from '@playwright/test';

        test.describe('Crystal Blitz - Performance Benchmarks', () => {
          test('performance benchmarks pass thresholds', async ({ page }) => {
            // Set longer timeout for CI environment
            test.setTimeout(60000);

            // Navigate to performance test page
            await page.goto('http://localhost:8000/performance-test.html', { waitUntil: 'load' });

            // Wait for benchmarks to complete (longer for CI)
            await page.waitForTimeout(20000);

            // Check summary for failures
            const summary = await page.locator('#summary').textContent();

            console.log('Summary:', summary);

            // Extract pass/fail counts
            const passMatch = summary.match(/(\d+) passed/);
            const failMatch = summary.match(/(\d+) failed/);

            const passed = passMatch ? parseInt(passMatch[1]) : 0;
            const failed = failMatch ? parseInt(failMatch[1]) : 0;

            console.log(`Performance Results: ${passed} passed, ${failed} failed`);

            // Fail if any benchmarks failed
            expect(failed).toBe(0);
            expect(passed).toBeGreaterThan(0);
          });
        });
        EOF

    - name: Start HTTP server
      run: |
        python3 -m http.server 8000 > /dev/null 2>&1 &
        echo $! > server.pid

    - name: Wait for server to be ready
      run: |
        for i in {1..30}; do
          if curl -s http://localhost:8000/ > /dev/null; then
            echo "Server is ready!"
            break
          fi
          echo "Waiting for server... ($i/30)"
          sleep 1
        done

    - name: Run performance benchmarks
      run: npx playwright test e2e/performance.spec.js --project=chromium

    - name: Upload performance results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: playwright-report/
        retention-days: 30

  unit-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Playwright
      run: |
        npm install -D @playwright/test
        npx playwright install --with-deps chromium

    - name: Create Playwright config
      run: |
        cat > playwright.config.js << 'EOF'
        import { defineConfig, devices } from '@playwright/test';

        export default defineConfig({
          testDir: './e2e',
          timeout: 30000,
          fullyParallel: false,
          forbidOnly: !!process.env.CI,
          retries: process.env.CI ? 2 : 0,
          workers: 1,
          reporter: [['html'], ['list']],
          use: {
            baseURL: 'http://localhost:8000',
            trace: 'on-first-retry',
            screenshot: 'only-on-failure',
            video: 'retain-on-failure',
          },
          projects: [
            {
              name: 'chromium',
              use: { ...devices['Desktop Chrome'] },
            },
          ],
        });
        EOF

    - name: Create e2e directory
      run: mkdir -p e2e

    - name: Create unit test runner
      run: |
        cat > e2e/unit-tests.spec.js << 'EOF'
        import { test, expect } from '@playwright/test';

        test.describe('Crystal Blitz - Unit Tests', () => {
          test('all unit tests pass', async ({ page }) => {
            // Navigate to unit tests page
            await page.goto('http://localhost:8000/unit-tests.html', { waitUntil: 'load' });

            // Wait for tests to complete
            await page.waitForTimeout(2000);

            // Check summary for failures
            const summary = await page.locator('#summary').textContent();

            console.log('Summary:', summary);

            // Extract pass/fail counts
            const passMatch = summary.match(/(\d+) passed/);
            const failMatch = summary.match(/(\d+) failed/);

            const passed = passMatch ? parseInt(passMatch[1]) : 0;
            const failed = failMatch ? parseInt(failMatch[1]) : 0;

            console.log(`Unit Test Results: ${passed} passed, ${failed} failed`);

            // Fail if any tests failed
            expect(failed).toBe(0);
            expect(passed).toBeGreaterThan(0);
          });
        });
        EOF

    - name: Start HTTP server
      run: |
        python3 -m http.server 8000 > /dev/null 2>&1 &
        echo $! > server.pid

    - name: Wait for server to be ready
      run: |
        for i in {1..30}; do
          if curl -s http://localhost:8000/ > /dev/null; then
            echo "Server is ready!"
            break
          fi
          echo "Waiting for server... ($i/30)"
          sleep 1
        done

    - name: Run unit tests
      run: npx playwright test e2e/unit-tests.spec.js --project=chromium

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: playwright-report/
        retention-days: 30

  status:
    runs-on: ubuntu-latest
    needs: [test, lint, performance, unit-tests]
    if: always()

    steps:
    - name: Check status
      run: |
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.lint.result }}" == "success" ] && [ "${{ needs.performance.result }}" == "success" ]; then
          echo "✅ All checks passed!"
          exit 0
        else
          echo "❌ Some checks failed"
          echo "Test result: ${{ needs.test.result }}"
          echo "Lint result: ${{ needs.lint.result }}"
          echo "Performance result: ${{ needs.performance.result }}"
          exit 1
        fi
